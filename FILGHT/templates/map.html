<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flight Route Map</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="/static/css/navbar.css" />
    <link rel="stylesheet" href="/static/css/map.css" />
  </head>
  <body>
    <nav class="menu">
      <ul>
        <li>
          <a href="/" class="{% if request.path == '/' %}active{% endif %}"
            >Home</a
          >
        </li>
        <li>
          <a
            href="/optimize/"
            class="{% if 'optimize' in request.path %}active{% endif %}"
            >Optimize</a
          >
        </li>
        <li>
          <a
            href="/report/"
            class="{% if 'report' in request.path %}active{% endif %}"
            >Report</a
          >
        </li>
        <!-- <li><a href="/flight-info/" class="{% if 'flight-info' in request.path %}active{% endif %}">Flight Info</a>
            </li> -->
        <li>
          <a
            href="/map/"
            class="{% if 'map' in request.path %}active{% endif %}"
            >Map</a
          >
        </li>
        <li>
          <a
            href="/about/"
            class="{% if 'about' in request.path %}active{% endif %}"
            >About</a
          >
        </li>
      </ul>
    </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h4>Flight Route Map</h4>
              <p class="mb-0">
                Interactive map showing all available airports and routes
              </p>
            </div>
            <div class="card-body">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Map Controls</h5>
            </div>
            <div class="card-body">
              <button class="btn btn-primary me-2" onclick="showAllAirports()">
                Show All Airports
              </button>
              <button class="btn btn-secondary me-2" onclick="clearMap()">
                Clear Map
              </button>
              <button class="btn btn-info" onclick="centerMap()">
                Center Map
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Statistics</h5>
            </div>
            <div class="card-body">
              <p>
                <strong>Total Airports:</strong>
                <span id="airportCount">0</span>
              </p>
              <p>
                <strong>Total Routes:</strong> <span id="routeCount">0</span>
              </p>
              <p>
                <strong>Map Center:</strong>
                <span id="mapCenter">Loading...</span>
              </p>
              <div id="legend" class="mt-3">
                <span
                  style="
                    display: inline-block;
                    width: 16px;
                    height: 16px;
                    background: #007bff;
                    border-radius: 50%;
                    margin-right: 5px;
                  "
                ></span>
                International
                <span
                  style="
                    display: inline-block;
                    width: 16px;
                    height: 16px;
                    background: #dc3545;
                    border-radius: 50%;
                    margin: 0 5px 0 15px;
                  "
                ></span>
                Domestic
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Initialize map
      var map = L.map("map").setView([39.8283, -98.5795], 4); // Center of USA
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "Â© OpenStreetMap contributors & CartoDB",
        }
      ).addTo(map);

      var markers = [];
      var routes = [];

      function showAllAirports() {
        // Clear existing markers
        markers.forEach((marker) => map.removeLayer(marker));
        markers = [];
        fetch("/api/all_airports/")
          .then((response) => response.json())
          .then((data) => {
            data.airports.forEach((airport) => {
              let color =
                airport.type === "international" ? "#007bff" : "#dc3545";
              let marker = L.circleMarker(
                [airport.latitude, airport.longitude],
                {
                  radius: 8,
                  fillColor: color,
                  color: "#fff",
                  weight: 1,
                  opacity: 1,
                  fillOpacity: 0.9,
                }
              ).addTo(map).bindPopup(`
                            <div class="airport-info">
                                <h6>${airport.code}</h6>
                                <p>${airport.name}</p>
                                <small>${airport.latitude.toFixed(
                                  4
                                )}, ${airport.longitude.toFixed(4)}</small><br>
                                <span style="color:${color};font-weight:bold;">${
                airport.type.charAt(0).toUpperCase() + airport.type.slice(1)
              }</span>
                            </div>
                        `);
              markers.push(marker);
            });
            document.getElementById("airportCount").textContent =
              data.airports.length;
          });
      }

      function clearMap() {
        markers.forEach((marker) => map.removeLayer(marker));
        routes.forEach((route) => map.removeLayer(route));
        markers = [];
        routes = [];
      }

      function centerMap() {
        map.setView([39.8283, -98.5795], 4);
        updateMapCenter();
      }

      function updateMapCenter() {
        const center = map.getCenter();
        document.getElementById(
          "mapCenter"
        ).textContent = `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
      }

      // Update map center when map moves
      map.on("moveend", updateMapCenter);

      function loadAirTraffic() {
        fetch("/api/air_traffic/")
          .then((response) => response.json())
          .then((data) => {
            showAirTraffic(data.air_traffic);
          })
          .catch((error) => console.error("Error loading air traffic:", error));
      }

      function showAirTraffic(airplanes) {
        airplanes.forEach((plane) => {
          const marker = L.marker([plane.latitude, plane.longitude], {
            icon: airplaneIcon,
          })
            .addTo(map)
            .bindPopup(
              `<b>Flight: ${plane.callsign || "Unknown"}</b><br>Altitude: ${
                plane.altitude || "-"
              } ft<br>Speed: ${plane.speed || "-"} kts`
            );
          markers.push(marker);
        });
      }

      // Load initial data
      loadAirTraffic();
      updateMapCenter();
    </script>
  </body>
</html>
