<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chatbot - Flight Path Optimization</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/navbar.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="menu">
      <ul>
        <li>
          <a href="/" class="{% if request.path == '/' %}active{% endif %}"
            >Home</a
          >
        </li>
        <li>
          <a
            href="/optimize/"
            class="{% if 'optimize' in request.path %}active{% endif %}"
            >Optimize</a
          >
        </li>
        <li>
          <a
            href="/report/"
            class="{% if 'report' in request.path %}active{% endif %}"
            >Report</a
          >
        </li>
        <!-- <li><a href="/flight-info/" class="{% if 'flight-info' in request.path %}active{% endif %}">Flight Info</a>
            </li> -->
        <li>
          <a
            href="/map/"
            class="{% if 'map' in request.path %}active{% endif %}"
            >Map</a
          >
        </li>
        <li>
          <a
            href="/about/"
            class="{% if 'about' in request.path %}active{% endif %}"
            >About</a
          >
        </li>
      </ul>
    </nav>
    <div class="container mt-4 mb-4">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
          <div class="card shadow">
            <div
              class="card-header bg-primary text-white d-flex align-items-center justify-content-between"
            >
              <div class="d-flex align-items-center gap-2">
                <span
                  class="rounded-circle bg-info d-flex align-items-center justify-content-center"
                  style="
                    width: 40px;
                    height: 40px;
                    font-weight: 600;
                    font-size: 1.2rem;
                  "
                  >AI</span
                >
                <div>
                  <h5 class="mb-0">AI Assistant</h5>
                  <small class="text-success">‚óè Online</small>
                </div>
              </div>
              <div>
                <button class="btn btn-light btn-sm me-1" title="Settings">
                  ‚öôÔ∏è
                </button>
                <button class="btn btn-light btn-sm" title="Call">üìû</button>
              </div>
            </div>
            <div
              class="card-body p-0"
              style="height: 500px; overflow-y: auto; background: #f8fafc"
              id="chatMessages"
            >
              <div class="d-flex mb-3">
                <div class="me-2">
                  <span
                    class="rounded-circle bg-info d-flex align-items-center justify-content-center"
                    style="
                      width: 32px;
                      height: 32px;
                      font-weight: 600;
                      font-size: 1rem;
                    "
                    >AI</span
                  >
                </div>
                <div>
                  <div class="bg-light border rounded-3 p-3 mb-1">
                    <span
                      >Hello! I'm your AI assistant for flight path
                      optimization. How can I help you today?</span
                    >
                  </div>
                  <small class="text-muted">Just now</small>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white border-top">
              <form id="chatForm" class="d-flex align-items-end gap-2">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  tabindex="-1"
                  disabled
                >
                  üìé
                </button>
                <div class="flex-grow-1">
                  <input
                    type="text"
                    id="messageInput"
                    class="form-control"
                    placeholder="Type your message..."
                    maxlength="500"
                    autocomplete="off"
                  />
                  <div class="d-flex justify-content-between mt-1">
                    <small class="text-muted" id="charCount">0/500</small>
                    <small class="text-muted">Powered by AI</small>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="sendBtn"
                  style="
                    height: 40px;
                    width: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <svg
                    width="22"
                    height="22"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M22 2L11 13"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M22 2L15 22L11 13L2 9L22 2Z"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const chatMessages = document.getElementById("chatMessages");
      const charCount = document.getElementById("charCount");
      // Character counter
      messageInput.addEventListener("input", function () {
        const count = this.value.length;
        charCount.textContent = `${count}/500`;
        charCount.classList.toggle("text-danger", count > 450);
      });
      // Send message function
      function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        addMessage(message, "user");
        messageInput.value = "";
        charCount.textContent = "0/500";
        charCount.classList.remove("text-danger");
        // Show typing indicator
        showTyping();
        fetch("/api/chat-gemini/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        })
          .then((res) => res.json())
          .then((data) => {
            hideTyping();
            addMessage(data.response || "No response from AI.", "bot");
          })
          .catch((err) => {
            hideTyping();
            addMessage("Error contacting AI: " + err, "bot");
          });
      }
      // Add message to chat
      function addMessage(text, sender) {
        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        const wrapper = document.createElement("div");
        wrapper.className =
          "d-flex mb-3 " + (sender === "user" ? "flex-row-reverse" : "");
        const avatar = document.createElement("div");
        avatar.className = sender === "user" ? "ms-2" : "me-2";
        avatar.innerHTML = `<span class="rounded-circle ${
          sender === "user" ? "bg-primary" : "bg-info"
        } d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: 600; font-size: 1rem;">${
          sender === "user" ? "You" : "AI"
        }</span>`;
        const msg = document.createElement("div");
        msg.innerHTML = `<div class="${
          sender === "user" ? "bg-primary text-white" : "bg-light"
        } border rounded-3 p-3 mb-1">${text.replace(
          /\n/g,
          "<br>"
        )}</div><small class="text-muted">${time}</small>`;
        wrapper.appendChild(avatar);
        wrapper.appendChild(msg);
        chatMessages.appendChild(wrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      // Typing indicator
      let typingDiv = null;
      function showTyping() {
        typingDiv = document.createElement("div");
        typingDiv.className = "d-flex mb-3";
        typingDiv.innerHTML = `<div class="me-2"><span class="rounded-circle bg-info d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-weight: 600; font-size: 1rem;">AI</span></div><div><div class="bg-light border rounded-3 p-3 mb-1"><span class="text-muted">AI is typing<span class="animated-dots">...</span></span></div></div>`;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      function hideTyping() {
        if (typingDiv) {
          chatMessages.removeChild(typingDiv);
          typingDiv = null;
        }
      }
      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      // On page load, check for AI card data
      window.addEventListener("DOMContentLoaded", function () {
        const aiCardData = localStorage.getItem("ai_card_data");
        if (aiCardData) {
          try {
            const { card, data } = JSON.parse(aiCardData);
            let cardName = card.replace(/_/g, " ");
            let message =
              `Please analyze this ${cardName} data:\n` +
              JSON.stringify(data, null, 2);
            addMessage(message, "user");
          } catch (e) {
            addMessage("Data sent from report page: " + aiCardData, "user");
          }
          fetch("/api/ask-ai/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: aiCardData,
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.summary) addMessage("Summary:\n" + data.summary, "bot");
              if (data.suggestions)
                addMessage(
                  "Suggestions to increase efficiency:\n" + data.suggestions,
                  "bot"
                );
              if (data.error) addMessage("Error: " + data.error, "bot");
            });
        }
      });
    </script>
  </body>
</html>
