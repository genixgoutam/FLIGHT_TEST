<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flight Information - Real-time Schedules & Prices</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Select2 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/navbar.css"> 
    <link rel="stylesheet" href="/static/css/flight.css">
  </head>
  <body>
    <nav class="menu">
      <ul>
          <li><a href="/" class="{% if request.path == '/' %}active{% endif %}">Home</a></li>
          <li><a href="/optimize/" class="{% if 'optimize' in request.path %}active{% endif %}">Optimize</a></li>
          <li><a href="/report/" class="{% if 'report' in request.path %}active{% endif %}">Report</a></li>
          <li><a href="/flight-info/" class="{% if 'flight-info' in request.path %}active{% endif %}">Flight Info</a>
          </li>
          <li><a href="/map/" class="{% if 'map' in request.path %}active{% endif %}">Map</a></li>
          {% comment %} <li><a href="/admin/" class="{% if 'admin' in request.path %}active{% endif %}">Admin</a></li> {% endcomment %}
          {% comment %} <li><a href="/flight/" class="{% if 'flight' in request.path %}active{% endif %}"></a></li> {% endcomment %}
      </ul>
  </nav>

    <div class="container mt-4">
      <div class="row">
        <div class="col-12">
          <h2>Real-time Flight Information</h2>
          <p class="text-muted">
            Get live flight schedules and pricing information
          </p>

          <div class="card">
            <div class="card-header">
              <h4>Search Flights</h4>
            </div>
            <div class="card-body">
              <form id="flight-search-form" autocomplete="off">
                <div class="mb-3">
                  <label for="origin" class="form-label">Origin Airport</label>
                  <select
                    class="form-select"
                    id="origin"
                    name="origin"
                    required
                  >
                    <option value="">Select origin airport...</option>
                    <!-- Dynamically load airports here using Django template tags -->
                    {% for airport in airports %}
                    <option value="{{ airport.id }}">
                      {{ airport.code }} - {{ airport.name }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="mb-3">
                  <label for="destination" class="form-label"
                    >Destination Airport</label
                  >
                  <select
                    class="form-select"
                    id="destination"
                    name="destination"
                    required
                  >
                    <option value="">Select destination airport...</option>
                    <!-- Dynamically load airports here using Django template tags -->
                    {% for airport in airports %}
                    <option value="{{ airport.id }}">
                      {{ airport.code }} - {{ airport.name }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  Search
                </button>
              </form>
            </div>
          </div>

          <div id="flight-results" class="mt-4"></div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
            $(document).ready(function () {
              // Initialize Select2 dropdowns
              $("#origin").select2({
                placeholder: "Select origin airport...",
                allowClear: true,
              });
              $("#destination").select2({
                placeholder: "Select destination airport...",
                allowClear: true,
              });

              // Handle form submit (for flight search)
              $("#flight-search-form").on("submit", function (e) {
                e.preventDefault();
                const origin = $("#origin").val();
                const destination = $("#destination").val();

                if (!origin || !destination) {
                  alert("Please select both origin and destination airports.");
                  return;
                }
                if (origin === destination) {
                  alert("Origin and destination airports cannot be the same.");
                  return;
                }

                // Get airport codes for display
                const originText = $("#origin option:selected").text();
                const destinationText = $("#destination option:selected").text();

                // Show loading state
                $("#flight-results").html('<div class="alert alert-info">Searching for flights...</div>');

                // Try multiple data sources
                Promise.all([
                  // Try database and local JSON files
                  fetch(`/api/flights/dynamic/?origin=${origin}&destination=${destination}`)
                    .then(response => response.json())
                    .catch(error => {
                      console.error("Database/JSON fetch error:", error);
                      return { flights: [] };
                    }),
                  
                  // Try external JSON files (like Supabase)
                  fetch(`/static/data/${originText.split(' - ')[0]}_to_${destinationText.split(' - ')[0]}_flights.json`)
                    .then(response => {
                      if (!response.ok) throw new Error("External file not found");
                      return response.json();
                    })
                    .then(data => {
                      // Convert external JSON format to our format
                      const flights = [];
                      const schedules = data.schedules || [];
                      const prices = data.prices || [];
                      
                      for (let i = 0; i < schedules.length; i++) {
                        const schedule = schedules[i];
                        const price = prices[i] || {};
                        flights.push({
                          flight_number: schedule.flight_number,
                          airline_name: schedule.airline,
                          departure_time: schedule.departure_time,
                          arrival_time: schedule.arrival_time,
                          duration: price.duration || '3h',
                          price: `${price.price || 'N/A'} ${price.currency || 'USD'}`,
                          status: schedule.status,
                          gate: schedule.gate,
                          terminal: schedule.terminal,
                          aircraft: schedule.aircraft,
                          source: 'external_json'
                        });
                      }
                      return { flights };
                    })
                    .catch(error => {
                      console.error("External JSON fetch error:", error);
                      return { flights: [] };
                    })
                ])
                .then(([dbResult, externalResult]) => {
                  // Combine results from all sources
                  const allFlights = [...dbResult.flights, ...externalResult.flights];
                  
                  if (allFlights.length === 0) {
                    $("#flight-results").html(
                      `<div class="alert alert-warning">No flights found from ${originText} to ${destinationText}.</div>`
                    );
                    return;
                  }
                  
                  displayFlightResults(originText, destinationText, { flights: allFlights });
                })
                .catch(error => {
                  console.error("All fetch attempts failed:", error);
                  $("#flight-results").html(
                    `<div class="alert alert-danger">Failed to fetch flight data. Please try again.</div>`
                  );
                });
              });

              // Function to display flight results
              function displayFlightResults(origin, destination, data) {
                const resultsContainer = $("#flight-results");
                resultsContainer.empty();

                if (data.flights.length === 0) {
                  resultsContainer.append(
                    `<div class="alert alert-info">No flights found from ${origin} to ${destination}.</div>`
                  );
                  return;
                }

                data.flights.forEach(flight => {
                  const sourceBadge = flight.source ? `<span class="badge bg-secondary ms-2">${flight.source}</span>` : '';
                  const statusBadge = flight.status ? `<span class="badge bg-${flight.status === 'On Time' ? 'success' : 'warning'} ms-2">${flight.status}</span>` : '';
                  
                  const flightCard = `
                    <div class="card flight-card mb-3">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                          <h5 class="card-title flight-number">${flight.flight_number}${sourceBadge}${statusBadge}</h5>
                          <span class="price-highlight">${flight.price}</span>
                        </div>
                        <p class="card-text airline-name">${flight.airline_name}</p>
                        <div class="row">
                          <div class="col-md-6">
                            <p class="card-text"><strong>Departure:</strong> ${flight.departure_time}</p>
                            <p class="card-text"><strong>Arrival:</strong> ${flight.arrival_time}</p>
                          </div>
                          <div class="col-md-6">
                            <p class="card-text"><strong>Duration:</strong> ${flight.duration}</p>
                            ${flight.gate ? `<p class="card-text"><strong>Gate:</strong> ${flight.gate}</p>` : ''}
                            ${flight.terminal ? `<p class="card-text"><strong>Terminal:</strong> ${flight.terminal}</p>` : ''}
                            ${flight.aircraft ? `<p class="card-text"><strong>Aircraft:</strong> ${flight.aircraft}</p>` : ''}
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                  resultsContainer.append(flightCard);
                });
                
                resultsContainer.append(
                  `<div class="alert alert-success">Showing ${data.flights.length} flights from ${origin} to ${destination}.</div>`
                );
              }
          });
    </script>
  </body>
</html>
