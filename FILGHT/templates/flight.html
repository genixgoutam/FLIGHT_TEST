<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Path Optimization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
    /* Minimal navbar styles */
    .menu {
        background: #222;
        padding: 0;
        margin-bottom: 20px;
        border-radius: 0 0 8px 8px;
    }
    .menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
    }
    .menu ul li {
        margin: 0;
    }
    .menu ul li a {
        display: block;
        color: #fff;
        padding: 12px 24px;
        text-decoration: none;
        transition: background 0.2s;
    }
    .menu ul li a.active, .menu ul li a:hover {
        background: #007b5e;
        color: #fff;
    }
    /* Optimize page card and map tweaks */
    #map-container .card {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    #map {
        border-radius: 8px;
        min-height: 400px;
    }
    .route-legend {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255,255,255,0.9);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95em;
        z-index: 1000;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    </style>
</head>
<body>
    <nav class="menu">
        <ul>
            <li><a href="/" class="{% if request.path == '/' %}active{% endif %}">Home</a></li>
            <li><a href="/optimize/" class="{% if 'optimize' in request.path %}active{% endif %}">Optimize</a></li>
            <li><a href="/report/" class="{% if 'report' in request.path %}active{% endif %}">Report</a></li>
            <li><a href="/flight-info/" class="{% if 'flight-info' in request.path %}active{% endif %}">Flight Info</a>
            </li>
            <li><a href="/map/" class="{% if 'map' in request.path %}active{% endif %}">Map</a></li>
            <li><a href="/admin/" class="{% if 'admin' in request.path %}active{% endif %}">Admin</a></li>
        </ul>
    </nav>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <h2>Flight Path Optimization</h2>
                <form id="routeForm" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="origin" class="form-label">Origin Airport</label>
                        <select class="form-select" id="origin" name="origin" required>
                            <option value="">Select origin airport...</option>
                            {% for airport in airports %}
                            <option value="{{ airport.id }}">{{ airport.code }} - {{ airport.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="destination" class="form-label">Destination Airport</label>
                        <select class="form-select" id="destination" name="destination" required>
                            <option value="">Select destination airport...</option>
                            {% for airport in airports %}
                            <option value="{{ airport.id }}">{{ airport.code }} - {{ airport.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Show Route</button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/optimize/'">Reset</button>
                </form>
                <!-- Remove static demo button and staticAllRoutes JS -->
                {% if all_routes %}
                  {{ all_routes|json_script:"all-routes-data" }}
                  <div style="margin: 1em 0; padding: 1em; background: #f8f9fa; border: 1px solid #ddd; font-size: 0.95em;">
                    <strong>Debug: all_routes</strong><br>
                    <pre id="allRoutesDebug"></pre>
                  </div>
                  <script>
                    document.addEventListener('DOMContentLoaded', function() {
                      var allRoutes = JSON.parse(document.getElementById('all-routes-data').textContent);
                      document.getElementById('allRoutesDebug').textContent = JSON.stringify(allRoutes, null, 2);
                      showMap(allRoutes);
                      document.getElementById('map-container').style.display = 'block';
                      document.getElementById('result').style.display = 'block';
                      document.getElementById('route-info').innerHTML = `<div class='alert alert-info'><strong><i class='fas fa-plane'></i> Main Route:</strong> ${allRoutes[0].path}<br><span class='text-danger'><strong>Alternatives:</strong> ${allRoutes.slice(1).map(function(r){return r.path;}).join(' | ')}</span></div>`;
                    });
                  </script>
                {% elif route %}
                  {{ route|json_script:"route-data" }}
                  <script>
                    document.addEventListener('DOMContentLoaded', function() {
                      var backendRoute = JSON.parse(document.getElementById('route-data').textContent);
                      showMap([{coordinates: backendRoute.map(function(p){return [p.lat, p.lon];}), path: backendRoute.map(function(p){return p.code;}).join(' → ')}]);
                      document.getElementById('map-container').style.display = 'block';
                      document.getElementById('result').style.display = 'block';
                      document.getElementById('route-info').innerHTML = `<div class='alert alert-info'><strong><i class='fas fa-plane'></i> Route:</strong> ${backendRoute.map(function(p){return p.code;}).join(' → ')}</div>`;
                    });
                  </script>
                {% endif %}
            </div>
            <div class="col-md-8">
                <div id="result" class="mt-4" style="display:none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0"><i class="fas fa-route"></i> Optimized Route</h4>
                        </div>
                        <div class="card-body">
                            <div id="route-info" class="alert alert-info"></div>
                        </div>
                    </div>
                </div>
                <div id="map-container" class="mt-4" style="display:none;">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0"><i class="fas fa-map"></i> Route Map</h4>
                        </div>
                        <div class="card-body">
                            <div id="map" style="height: 400px; width: 100%; border-radius: 8px; position: relative;"></div>
                            <div class="route-legend" style="margin-top: 10px;">
                                <h6><i class="fas fa-info-circle"></i> Route Colors:</h6>
                                <div><span style="display:inline-block;width:16px;height:8px;background:green;margin-right:6px;"></span> Best Route</div>
                                <div><span style="display:inline-block;width:16px;height:8px;background:blue;margin-right:6px;"></span> Other Routes</div>
                                <div><span style="display:inline-block;width:16px;height:8px;background:#007b5e;margin-right:6px;border-radius:50%;"></span> Stops</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Route Details Modal -->
    <div class="modal fade" id="routeDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Route Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="routeDetailContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="bookRoute()">Book This Route</button>
                </div>
            </div>
        </div>
    </div>
    
    {{ airports|json_script:"airports-data" }}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // This block is now redundant as the script is moved outside
      });
    </script>
    
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.geodesic"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    let map, polylines = [], markers = [];
    let flightData = [];
    
    function showMap(routes) {
        console.log('showMap called with routes:', routes); // Debug log
        document.getElementById('map-container').style.display = 'block';
        
        if (!map) {
            console.log('Creating new map'); // Debug log
            map = L.map('map').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        } else {
            console.log('Clearing existing map layers'); // Debug log
            polylines.forEach(p => map.removeLayer(p));
            markers.forEach(m => map.removeLayer(m));
            polylines = [];
            markers = [];
        }
        
        routes.forEach((route, idx) => {
            console.log('Drawing route:', route.coordinates);
            if (!route.coordinates || !Array.isArray(route.coordinates) || route.coordinates.length < 2) {
                console.warn(`Route ${idx} has invalid coordinates:`, route.coordinates);
                return;
            }
            const color = idx === 0 ? 'green' : 'blue';
            const weight = idx === 0 ? 5 : 3;
            // Use polyline for compatibility
            const polyline = L.polyline(route.coordinates, {
                weight: weight,
                color: color,
                opacity: 0.8
            }).addTo(map);
            polylines.push(polyline);
            route.coordinates.forEach((coord, i) => {
                if (coord && Array.isArray(coord) && coord.length === 2) {
                    let label = 'Stop';
                    if (i === 0) label = 'Origin';
                    else if (i === route.coordinates.length - 1) label = 'Destination';
                    const marker = L.marker(coord, {icon: L.icon({iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [25, 41], iconAnchor: [12, 41]})})
                        .addTo(map)
                        .bindPopup(`${label}<br>${route.path ? route.path.split(' → ')[i] || 'Stop' : 'Stop'}`);
                    markers.push(marker);
                }
            });
        });
        
        // Force map to fit all route bounds
        if (routes.length > 0 && polylines.length > 0) {
            const allCoords = [].concat(...routes.map(r => r.coordinates));
            map.fitBounds(allCoords);
        } else {
            console.warn('No valid routes to display on map'); // Debug log
        }
    }
    // Remove JS fetch and form submit handler for normal POST
    document.getElementById('sendToReport').addEventListener('click', function() {
        localStorage.setItem('optimizationReport', JSON.stringify(window.optimizationData));
        window.location.href = '/report/';
    });
    $(document).ready(function() {
        $("#origin").select2({
            placeholder: "Select origin airport...",
            allowClear: true
        });
        $("#destination").select2({
            placeholder: "Select destination airport...",
            allowClear: true
        });
    });
    </script>
</body>
</html>


